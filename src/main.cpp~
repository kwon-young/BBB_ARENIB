
#include "utils.h"


int main (int argc, char *argv[]) {
  for (int i=0; i<argc; i++) {
    if (i==1) {
      printf ("argc = %d : %s\n", argv[i]);
    }
    else if (i==2) {
      printf ("argc = %d : %s\n", argv[i]);
    }
  }
  int i2c_bus=1;
  int i2c_addr=0x48;

  char name_bus[42];
  snprintf(name_bus, sizeof(name_bus), "/dev/i2c-%d", i2c_bus);

  int i2c_file;
  RESTART_SYSCALL(i2c_file, open(name_bus, O_RDWR));
  if (i2c_file==-1) {
    char * err_str[10+strlen(name_bus)]; 
    sprintf(err_str, "open %s", name_bus);
    perror(err_str);
    return -1;
  }
  
  int r;
  RESTART_SYSCALL(r, ioctl(i2c_file, I2C_SLAVE, i2c_addr));
  if (r==-1) {
    char * err_str[10+strlen(name_bus)]; 
    sprintf(err_str, "ioctl %s", name_bus);
    perror(err_str);
    return -1;
  }

  char buff[1]={ 0x0 };
  RESTART_SYSCALL(r, write(i2c_file, buff, 1));
  if (r==-1) {
    perror("write start bit");
  }

  char temp[4];
  RESTART_SYSCALL(r, read(i2c_file, temp, sizeof(temp)));
  if (r!=sizeof(temp)) {
    perror("read temp");
  }
  int temp_int=((temp[2]<<8) | (temp[3]<<4) | temp[0]) >> 3;
  if (temp_int>>8) {
    temp_int*=-1;
    temp_int&=~(1<<8);
  }
  printf("il fait %d degree celsius\n", 

}


